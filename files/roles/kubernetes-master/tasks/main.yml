---
- debug:
    var: token

- name: Initialize Kubernetes cluster
  become: yes
  shell: kubeadm init --token="{{ token }}"

- name: Create .kube directory
  become: yes
  file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory

- name: Copy config file
  become: yes
  copy:
    src: /etc/kubernetes/admin.conf
    dest: "{{ ansible_env.HOME }}/.kube/config"
    remote_src: yes
    mode: 0777
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"

- name: Add iptable config
  shell: sysctl net.bridge.bridge-nf-call-iptables=1

- name: Kubever
  shell: export kubever=$(kubectl version | base64 | tr -d '\n') && kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$kubever"

- name: Apply version
  shell: kubectl taint nodes --all node-role.kubernetes.io/master-

- name: Pause 30 seconds
  pause:
    seconds: 30

- name: Applying Kubernetes Network Provider settings
  shell: sudo kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=1.10"
  args:
    warn: false
...
